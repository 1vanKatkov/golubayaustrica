{% load static format_filters %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Топ игроков — Голубая Устрица</title>
    <style>
      :root {
        color: #fff;
        background: #030305;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        --red: #e63b3b;
        --mid-gray: #1c1f29;
        --light-gray: #cfd2dd;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #030305;
      }

      .page {
        padding: 3rem clamp(1rem, 3vw, 4rem) 4rem;
        min-height: 100vh;
        background: radial-gradient(circle at top right, rgba(230, 59, 59, 0.25), transparent),
          linear-gradient(180deg, rgba(3, 3, 5, 0.9), #000);
      }

      .hero-header {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-end;
        justify-content: space-between;
        gap: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }

      .hero-header h1 {
        margin: 0;
        font-size: clamp(2.25rem, 3vw, 3rem);
      }

      .hero-button {
        padding: 0.65rem 1.5rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(230, 59, 59, 0.2);
        color: #fff;
        font-size: 0.7rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        text-decoration: none;
        transition: background 0.3s ease;
      }

      .hero-button:hover {
        background: var(--red);
      }

      .players-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
        font-size: 0.95rem;
        background: var(--mid-gray);
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.55);
      }

      .players-table th,
      .players-table td {
        padding: 0.9rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        text-align: center;
        vertical-align: middle;
      }

      .players-table th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.3em;
        color: var(--light-gray);
      }

      .players-table tbody tr {
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .players-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .player-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.35rem;
      }

      .player-avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: #111;
      }


      .player-modal {
        position: fixed;
        inset: 0;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 200;
      }

      .player-modal.active {
        display: flex;
      }

      .player-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
      }

      .player-modal__content {
        position: relative;
        background: #07080f;
        border-radius: 24px;
        padding: 2rem;
        max-width: 520px;
        width: min(90vw, 520px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
        z-index: 1;
      }

      .player-modal__close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        border: none;
        background: transparent;
        color: #fff;
        font-size: 1.2rem;
        cursor: pointer;
      }

      .player-modal__avatar {
        width: 92px;
        height: 92px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 1rem;
      }

      .player-modal__title {
        margin: 0;
        font-size: 1.5rem;
        letter-spacing: 0.05em;
      }

      .player-modal__desc {
        margin: 0.35rem 0 1rem;
        color: var(--light-gray);
        font-size: 0.95rem;
        line-height: 1.6;
      }

      .player-modal__results {
        margin: 1rem 0;
        font-size: 0.85rem;
        color: var(--light-gray);
        display: flex;
        justify-content: space-between;
      }

      .player-modal__results span {
        display: block;
      }

      .player-modal__recent {
        margin-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 1rem;
      }

      .player-modal__recent-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }

      .player-modal__total {
        font-size: 0.75rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--light-gray);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="hero-header">
        <h1>Топ игроков</h1>
        <a class="hero-button" href="{% url 'landing' %}">На главную</a>
      </header>
      <div class="table-wrapper">
        <table class="players-table">
          <thead>
            <tr>
              <th>Игрок</th>
              <th>Сумма</th>
              <th>Сессий</th>
              <th>Лучший результат</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in top_players %}
            <tr
              class="player-row"
              data-player-id="{{ entry.player.id }}"
              data-player-name="{{ entry.player.name|escapejs }}"
              data-player-desc="{{ entry.player.description|default:''|escapejs }}"
            data-player-photo="{{ entry.player.photo_filename|default:'anon.jpg'|escapejs }}"
              data-total="{{ entry.total }}"
              data-session-count="{{ entry.session_count }}"
              data-best-id="{{ entry.best.id }}"
              data-best-date="{{ entry.best.date }}"
              data-best-result="{{ entry.best.result }}"
              data-worst-id="{{ entry.worst.id }}"
              data-worst-date="{{ entry.worst.date }}"
              data-worst-result="{{ entry.worst.result }}"
              data-script-id="{{ entry.script_id }}"
            >
              <td>
                <div class="player-cell">
                <img
                  class="player-avatar"
                  src="{% static 'photo/' %}{{ entry.player.photo_filename|default:'anon.jpg'|urlencode }}"
                  alt="Фото {{ entry.player.name }}"
                />
                  {{ entry.player.name }}
                </div>
              </td>
              <td>{{ entry.total|format_result }}</td>
              <td>{{ entry.session_count }}</td>
              <td>{{ entry.best.result|format_result }}</td>
            </tr>
            {{ entry.recent_sessions|json_script:entry.script_id }}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="player-modal" id="player-modal">
      <div class="player-modal__backdrop"></div>
      <div class="player-modal__content">
        <button class="player-modal__close" type="button">×</button>
        <img class="player-modal__avatar" src="" alt="" data-modal-photo />
        <h2 class="player-modal__title" data-modal-name></h2>
        <p class="player-modal__desc" data-modal-desc></p>
        <div class="player-modal__total">
          Всего: <span data-modal-total></span>
        </div>
        <div class="player-modal__results">
          <div>
            <span>Лучшая</span>
            <strong data-modal-best></strong>
          </div>
          <div>
            <span>Худшая</span>
            <strong data-modal-worst></strong>
          </div>
        </div>
        <div class="player-modal__recent">
          <div class="player-modal__total">Последние сессии</div>
          <div data-modal-recent></div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const modal = document.getElementById("player-modal");
        if (!modal) return;
        const closeButton = modal.querySelector(".player-modal__close");
        const photo = modal.querySelector("[data-modal-photo]");
        const nameEl = modal.querySelector("[data-modal-name]");
        const descEl = modal.querySelector("[data-modal-desc]");
        const totalEl = modal.querySelector("[data-modal-total]");
        const bestEl = modal.querySelector("[data-modal-best]");
        const worstEl = modal.querySelector("[data-modal-worst]");
        const recentList = modal.querySelector("[data-modal-recent]");

        function formatResult(val) {
          if (val === "" || val === null || typeof val === "undefined") {
            return "";
          }
          const number = Number(val);
          if (!Number.isFinite(number)) {
            return val.toString();
          }
          if (Number.isInteger(number)) {
            return number.toString();
          }
          const fixed = number.toFixed(2);
          return fixed.replace(".", ",").replace(/,?0+$/, (match) =>
            match.includes(",") ? "" : match
          );
        }

        function closeModal() {
          modal.classList.remove("active");
        }

        function renderRecent(recentData) {
          recentList.innerHTML = "";
          if (!Array.isArray(recentData) || recentData.length === 0) {
            recentList.innerHTML =
              '<div class="player-modal__recent-item">Нет данных</div>';
            return;
          }
          recentData.forEach(function (session) {
            const item = document.createElement("div");
            item.className = "player-modal__recent-item";
            item.innerHTML =
              "<span>Сессия #" +
              session.session_id +
              " — " +
              session.date +
              "</span><strong>" +
              formatResult(session.result) +
              "</strong>";
            recentList.appendChild(item);
          });
        }

        const photoBase = "{% static 'photo/' %}";
        document
          .querySelectorAll(".player-row")
          .forEach(function (row) {
            row.addEventListener("click", function () {
              const scriptId = row.dataset.scriptId;
              const recentDataEl = document.getElementById(scriptId);
              const recentData = recentDataEl
                ? JSON.parse(recentDataEl.textContent)
                : [];
              photo.src = row.dataset.playerPhoto
                ? photoBase + row.dataset.playerPhoto
                : photoBase + "anon.jpg";
              photo.alt = "Фото " + row.dataset.playerName;
              nameEl.textContent = row.dataset.playerName;
              descEl.textContent = row.dataset.playerDesc || "";
              totalEl.textContent = formatResult(row.dataset.total);
              const bestId = row.dataset.bestId;
              const bestDate = row.dataset.bestDate;
              const bestResult = formatResult(row.dataset.bestResult);
              bestEl.textContent = bestId
                ? "#" +
                  bestId +
                  (bestDate ? " — " + bestDate : "") +
                  " / " +
                  bestResult
                : "нет";
              const worstId = row.dataset.worstId;
              const worstDate = row.dataset.worstDate;
              const worstResult = formatResult(row.dataset.worstResult);
              worstEl.textContent = worstId
                ? "#" +
                  worstId +
                  (worstDate ? " — " + worstDate : "") +
                  " / " +
                  worstResult
                : "нет";
              renderRecent(recentData);
              modal.classList.add("active");
            });
          });

        closeButton.addEventListener("click", closeModal);
        modal.addEventListener("click", function (event) {
          if (
            event.target === modal ||
            event.target === modal.querySelector(".player-modal__backdrop")
          ) {
            closeModal();
          }
        });
      })();
    </script>
  </body>
</html>

